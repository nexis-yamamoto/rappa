# LilyPond 再生機能計画

目標: LilyPond (.ly) 形式を MIDI に変換し、既存の pygame ベースのシンセサイザーパイプラインを再利用して再生機能を追加する。CLI/MCP のサポート、ドキュメントと依存関係の更新も行う。

## アプローチ
- LilyPond を MIDI に変換し、既存の再生機能を再利用する。
  - **注記**: LilyPond は標準的な ABC 記法では表現できない打楽器パートなどを表現できるため、ABC への変換は行わず、MIDI への変換を採用する。
- 実装方針:
  - `python-ly` を使用して LilyPond を解析し、`mido` を使用して MIDI メッセージを構築する。
  - `lilypond` CLI は使用しない（外部依存を避けるため）。
- 最小限の初期実装: 音符と長さ、テンポを反映する。強弱記号やアーティキュレーションは最初は省略する。

## タスク
1) コンバーター: .ly テキストまたはファイルを読み込み、`python-ly` で解析して MIDI オブジェクトまたはパスを生成するモジュールを追加する。
2) CLI: rappa.py の検出機能を拡張し、.ly または LilyPond テキストを受け入れ、コンバーターを経由して既存の MIDI 再生機能にルーティングする。
3) MCP: 新しいツール `play_lilypond` を追加する。これは LilyPond コンテンツを受け入れ、コンバーターと再生機能を呼び出す。
4) 依存関係/設定: pyproject.toml に `python-ly` を追加する。
5) ドキュメント: README を更新し、LilyPond の使用例と制限事項を記載する。
6) テスト: サンプル .ly -> 再生を確認する。MIDI 保存が引き続き機能することを確認する。不正な LilyPond 入力に対するエラー報告を処理する。

## 未解決の質問
- 再現性の範囲: 今すぐ強弱/楽器のサポートが必要か、それとも最小限に留めるか？（初期実装は最小限とする）

## 受け入れ基準 (最小実行可能製品)
- CLI: `python rappa.py path/to/score.ly` で、既存のシンセサイザーを通じて正しいテンポで音符が再生される。
- MCP: 新しいツール `play_lilypond` が LilyPond コンテンツを受け入れ、再生する。
- README: 使用方法が文書化され、依存関係がリストされている。
